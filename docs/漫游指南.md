# 漫游指南

# The Hitchhiker's Guide to the JmcAuto

> 本文档使用markdown语法编辑，为达到最佳显示效果，请使用markdown编辑器打开，推荐在安装Apollo内核后安装Typora，命令如下：
>
> ```shell
> # 下两条命令二选一
> # sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA300B7755AFCFAE
> wget -qO - https://typora.io/linux/public-key.asc | sudo apt-key add -
>
> # 添加Typora源
> sudo add-apt-repository 'deb https://typora.io/linux ./'
> sudo apt-get update
>
> # 安装Typora
> sudo apt-get install typora
> ```

## 安装Ubuntu

1. 开机后按F2进入bios设置界面，boot选项中改成dual boot选项，efi device first选项enable，按F10保存重启

2. 开机后按F12选择U盘安装启动，使用UEFI安装方式（联网安装，安装语言建议英文）

## 配置 Ubuntu

### 替换更新源为清华源

**Ubuntu 14.04** 安装完成后替换系统更新源为国内镜像源。

1. 按 Ctrl + Alt + T 打开终端，输入以下命令：

   ```shell
   sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak  #备份源
   sudo gedit /etc/apt/sources.list  #编辑源列表
   #复制井号后文字不影响命令
   ```

   > 如需使用 VIM ，在更新源结束后输入`sudo apt-get install vim`

2. 复制下列源完全替换之前的源：

   ```shell
   # 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
   deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty main restricted universe multiverse
   # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty main restricted universe multiverse
   deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
   # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-updates main restricted universe multiverse
   deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
   # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-backports main restricted universe multiverse
   deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-security main restricted universe multiverse
   # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty-security main restricted universe multiverse
   ```

3. 执行软件更新器

   ```shell
   sudo apt-get update  #更新列表
   sudo apt-get upgrade  #更新软件
   ```

### 安装内核

1. 打开终端，输入以下命令安装 Linux 4.4 内核：

   ```shell
   sudo apt-get install linux-generic-lts-xenial
   ```

2. 安装完成后输入 `sudo reboot` 命令重启系统

3. **拷贝内核及驱动文件夹**`install_drivers`到家目录`~/`后，输入以下命令：

   ```shell
   cd install_drivers
   tar -zxvf linux-4.4.32-apollo-1.5.5.tar.gz  #路径因人而异
   cd install
   sudo bash install_kernel.sh
   ```

4. 安装完成后输入 `sudo reboot` 命令重启系统

5. 重启后在终端输入：`cat /proc/version` 查看内核版本

   >添加 Ubuntu 对 exfat 的支持： `sudo apt-get install exfat-utils`

## 安装 NVIDIA 驱动、CUDA、cuDNN 工具

> 首先查看当前插入的显卡是否被正确识别：`lspci | grep -i nvidia`
>
> 如无法正确显示显卡型号，输入：`sudo update-pciids`
>
> 更新系统的PCI ID

1. 打开终端，**进入`install_drivers`文件夹**，输入以下命令，安装NVIDIA显卡驱动：

   ```shell
   chmod +x ./NVIDIA-Linux-x86_64-375.39.run  #编辑权限
   sudo bash NVIDIA-Linux-x86_64-375.39.run --no-x-check -a -s --no-kernel-module
   ```

   >笔记本安装时需要在最后加上：`--no-opengl-files`

2. 输入以下命令，并根据提示安装 CUDA 工具：

   ```shell
   sudo chmod a+x ./cuda_8.0.61_375.26_linux.run  #编辑权限
   sudo bash cuda_8.0.61_375.26_linux.run --silent --toolkit --tmpdir=/dev
   #配置环境变量，见最后的配置系统环境变量
   #echo "export PATH=$PATH:/usr/local/cuda/bin" >> ${HOME}/.bashrc
   ```

3. 安装完成后输入`sudo reboot`命令重启系统，重启后在应用中能看到 NVIDIA 工具以及 CUDA 工具

4. 打开终端，**进入`install_drivers`文件夹**，输入以下命令安装 cuDNN 工具：

   ```shell
   tar -zxvf cudnn-8.0-linux-x64-v7.tgz
   sudo cp cuda/include/cudnn.h /usr/local/cuda/include
   sudo cp cuda/lib64/libcudnn* /usr/local/cuda/lib64
   sudo chmod a+r /usr/local/cuda/include/cudnn.h 
   sudo chmod a+r /usr/local/cuda/lib64/libcudnn*
   #用deb包安装cuDNN执行以下命令
   #sudo dpkg -i libcudnn7-dev_7.1.1.5-1+cuda8.0_amd64.deb
   ```

5. 完成后重启系统

## 根据工控机上的 CAN 卡选择安装的驱动

### 1. 安装 ESC_CAN 驱动

1. **拷贝驱动文件到根目录下**，在终端中输入以下命令：

   ```shell
   sudo apt-get install dkms
   cd ~/esdcan-pcie402-linux-2.6.x-x86_64-3.10.3
   sudo su
   ```

2. 输入以下命令安装驱动：

   ```shell
   dkms add ./src
   dkms build esdcan-pcie402-linux-2.6.x-x86_64/3.10.3
   dkms install esdcan-pcie402-linux-2.6.x-x86_64/3.10.3
   ```

3. 创建索引节点：

   ```shell
   cd /dev
   sudo mknod --mode=a+rw can0 c 52 0
   ```

4. **关闭终端或者退出 root 用户 **

5. 拷贝 ESDCAN 库到 Apollo 文件夹（在 CAN 卡适配指南中）

### 2. 安装 SOCKET_CAN 驱动

1. **拷贝驱动文件到根目录下**，在终端中输入以下命令：

   ```shell
   cd ~/EMUC-B202_SocketCAN_Driver_v2.2_Utility_v2.2
   sudo make clean
   make
   ```

2. 拷贝 emuc2socketcan.ko 文件

   ```shell
   cp ~/EMUC-B202_SocketCAN_Driver_v2.2_Utility_v2.2/driver/emuc2socketcan.ko ~/can/
   ```

3. 输入以下命令安装驱动：

   ```shell
   sudo bash ~/can/install_can.sh
   ```

## 一些系统配置

- 在系统设置 Network 中将第二个连接的 IPV4 settings 中，连接方式改为 shared to other computers（网线连接工控机第二个网口可直接工控机）

- 安装 vim、openssh 等常用软件：

  ```shell
  sudo apt install vim openssh-server
  ```

## 配置依赖

1. 从远程服务器上下载软件包：

   ```shell
   sudo mkdir /home/tmp  #创建tmp文件夹
   sudo chown ${USER}:${USER} /home/tmp  #修改tmp文件夹权限
   scp -r caros@10.89.114.243:/mnt/tmp /home/tmp  #拷贝远程服务器上的tmp文件夹到本地
   ```


2. 解压到tmp文件夹：

   ```shell
   cd /home/tmp
   tar -zxvf ros-indigo-apollo-2.1.2-x86_64.tar.gz  #根据实际情况修改包名
   ```

## 获取源码

1. 使用 git 工具获取 JmcAuto 源码：

   ```shell
   git clone ssh://caros@10.89.114.243//mnt/jmcauto.git
   cd jmcauto
   git checkout <分支名>  #带-b参数时为新建分支
   #git的其他用法请查看README.md
   ```

2. 配置环境变量（**多人共用的工控机请勿配置**）：

   ```shell
   #默认注释了，多人共用的工控机上配置环境变量会导致BUG
   #echo "export JMC_AUTO_HOME=~/jmcauto" >> ~/.bashrc
   #echo "export PATH=~/jmcauto/scripts:$PATH" >> ~/.bashrc
   #source ~/.bashrc
   ```

### 安装 Docker

1. 打开终端，输入以下命令

   ```shell
   bash ~/jmcauto/docker/install_docker.sh
   ```

2. 安装完成后输入`sudo reboot`命令重启系统

3. **重启后验证非管理员权限下访问 Docker**，在终端中输入以下命令：

   ```
   docker run hello-world
   ```

   安装并配置成功的话会拉取镜像并显示 Docker 欢迎界面

### 导入镜像

> 一台工控机只需导入一次，后续有更新再重新导入

1. 打开终端，输入以下命令从远程服务器下载镜像：

   ```shell
   scp caros@10.89.114.243:/mnt/jmc_imgs.tar.gz ./
   ```

2. 完成后输入以下命令：

   ```shell
   docker load --input jmc_imgs.tar.gz
   ```

## 在镜像中编译及测试

1. 打开终端，输入以下命令进入 docker 镜像：

   ```shell
   bash scripts/docker_into.sh
   ```

2. **在 Docker 环境中**，输入以下命令编译：

   ```shell
   bash jmc_auto.sh build  #还有其他编译选项，输入：bash jmc_auto.sh help查看
   ```

### 启动 Dreamview

**编译完成后**，输入以下命令以启动 Dreamview WEB 交互界面：

```shell
bash scripts/bootstrap.sh
```

用浏览器访问 [http://localhost:8888](http://localhost:8888)

- `bash scripts/bootstrap.sh stop  #退出 Dreamview`
